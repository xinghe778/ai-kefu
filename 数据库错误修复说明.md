# 数据库错误修复说明

## 问题描述
您遇到的错误：`SQLSTATE[42S02]: Base table or view not found: 1146 Table '121_4_54_239.logs' doesn't exist`

## 问题原因
项目中存在表名不一致的问题：
- 数据库初始化脚本创建的是 `chat_logs` 表
- 代码中查询的是 `logs` 表
- 导致查询时找不到对应的表

## 解决方案

### 1. 修复的代码文件
已修复以下文件中的表名：
- ✅ `admin/index.php` - 第10行
- ✅ `admin/log-delete.php` - 第14行  
- ✅ `admin/logs.php` - 第50、61、87行
- ✅ `admin/log.php` - 第147行

### 2. 运行的数据库修复脚本
请按以下步骤执行数据库修复：

```sql
-- 方法1: 使用提供的修复脚本
mysql -u root -p api < fix_database.sql

-- 方法2: 手动执行
mysql -u root -p api

-- 执行以下 SQL 命令：
CREATE TABLE IF NOT EXISTS `chat_logs` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) DEFAULT NULL,
  `username` varchar(50) DEFAULT NULL,
  `message` longtext NOT NULL,
  `response` longtext NOT NULL,
  `model_used` varchar(100) DEFAULT NULL,
  `tokens_used` int(11) DEFAULT NULL,
  `response_time` decimal(10,3) DEFAULT NULL,
  `ip_address` varchar(45) DEFAULT NULL,
  `user_agent` text,
  `action` varchar(100) DEFAULT NULL,
  `description` text,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_model` (`model_used`)
);

-- 插入默认管理员账户（如果不存在）
INSERT IGNORE INTO `users` (`username`, `password`, `email`, `role`) VALUES
('admin', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'admin@yizi.com', 'admin');

-- 插入默认设置（如果不存在）
INSERT IGNORE INTO `settings` (`api_key`, `api_url`, `prompt`, `kb_enabled`, `kb_threshold`, `kb_max_results`) VALUES
('', 'https://api.spanstar.cn', '你是一个有用的AI助手，请用友好、专业的方式回答用户的问题。', 1, 0.70, 5);
```

### 3. 默认登录信息
修复后，您可以使用以下账户登录：
- **用户名**: admin
- **密码**: admin123
- **建议**: 登录后立即修改默认密码

## 验证修复
修复完成后，请访问：
1. `http://您的域名/admin/index.php` - 管理员面板
2. 检查是否还有"Table doesn't exist"错误
3. 确认可以正常查看统计数据

## 技术说明
- 统一使用 `chat_logs` 表名（更符合聊天系统的命名规范）
- 保持了与数据库初始化脚本的完全一致
- 所有日志相关的功能都指向正确的表

## 文件清单
修复涉及的文件：
- `admin/index.php` - 修复表名
- `admin/log-delete.php` - 修复表名  
- `admin/logs.php` - 修复表名
- `admin/log.php` - 修复表名
- `fix_database.sql` - 数据库修复脚本
- `数据库错误修复说明.md` - 本文档

---

**修复完成时间**: 2025-11-23
**修复状态**: ✅ 完成