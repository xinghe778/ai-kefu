<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YiZi AI - æ™ºèƒ½å®¢æœ</title>
    
    <!-- CDN èµ„æº -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    
    <!-- ç¬¬ä¸‰æ–¹åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.2/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>

    <style>
        /* ä¸»é¢˜è‰²å®šä¹‰ */
        :root {
            --primary-900: #1e3b8a;
            --primary-600: #2563eb;
            --primary-400: #93c5fd;
            --secondary-600: #7c3aed;
            --accent-400: #fb923c;
            --surface-1: #f8f9fa;
            --surface-2: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-lg: 0 12px 24px -6px rgba(0,0,0,0.1);
        }

        /* æ·±è‰²æ¨¡å¼ */
        [data-bs-theme="dark"] {
            --surface-1: #1a1a1a;
            --surface-2: #2c2c2c;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: var(--surface-1);
            color: var(--text-primary);
            font-family: 'Inter', system-ui, sans-serif;
            line-height: 1.6;
        }

        /* å®¹å™¨å¸ƒå±€ */
        .chat-container {
            max-width: 900px;
            width: 100%;
            margin: 2rem auto;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            background: var(--surface-2);
            transition: all 0.3s ease;
        }

        /* é¡µçœ‰æ ·å¼ */
        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            background: linear-gradient(145deg, var(--primary-600), var(--secondary-600));
            color: white;
        }

        .chat-header h5 {
            margin: 0;
            font-weight: 600;
            font-size: 1.25rem;
        }

        /* æ¨¡å‹é€‰æ‹© */
        .model-select {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            background: var(--surface-2);
        }

        /* èŠå¤©å†å² */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-height: calc(100vh - 320px);
            scroll-behavior: smooth;
        }

        /* æ¶ˆæ¯æ°”æ³¡ */
        .message-bubble {
            padding: 1rem 1.25rem;
            border-radius: 1rem;
            position: relative;
            max-width: 80%;
            animation: fadeInUp 0.4s ease-out;
        }

        .user-message {
            align-self: flex-end;
            background: var(--primary-600);
            color: white;
            border-radius: 1.5rem 0.5rem 0.5rem 0.5rem;
        }

        .assistant-message {
            align-self: flex-start;
            background: var(--surface-2);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 0.5rem 1.5rem 0.5rem 0.5rem;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-panel {
            border-top: 1px solid rgba(0,0,0,0.08);
            padding: 1.5rem;
            background: var(--surface-2);
        }

        /* æ–‡ä»¶ä¸Šä¼  */
        .file-dropzone {
            border: 2px dashed rgba(37,99,235,0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-dropzone:hover {
            border-color: var(--primary-400);
            background: rgba(37,99,235,0.03);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .chat-container {
                margin: 1rem;
                border-radius: 0;
            }
            
            .chat-history {
                padding: 1.5rem 1rem;
            }
            
            .message-bubble {
                max-width: 100%;
            }
        }

        /* åŠ¨ç”» */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ‰“å­—æ•ˆæœ */
        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background: var(--primary-400);
            margin-left: 2px;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--surface-2);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            padding: 0.5rem;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body data-bs-theme="light">
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="åˆ‡æ¢ä¸»é¢˜">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <!-- èŠå¤©å®¹å™¨ -->
    <div class="chat-container">
        <!-- é¡µçœ‰ -->
        <div class="chat-header d-flex align-items-center">
            <i class="fas fa-robot me-2"></i>
            <h5>YiZi AI å®¢æœåŠ©æ‰‹</h5>
        </div>

        <!-- æ¨¡å‹é€‰æ‹© -->
        <div class="model-select">
            <label for="modelSelect" class="form-label">é€‰æ‹©æ¨¡å‹ï¼š</label>
            <select id="modelSelect" class="form-select">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
        </div>

        <!-- èŠå¤©å†å² -->
        <div class="chat-history" id="chatWindow">
            <!-- æ¬¢è¿ä¿¡æ¯ -->
            <div class="welcome-message text-center py-5">
                <div class="mb-4" style="font-size: 3.5rem">ğŸš€</div>
                <h2 class="mb-3 fw-semibold">æ¬¢è¿ä½¿ç”¨ YiZi AI</h2>
                <p class="text-muted">æ‚¨çš„æ™ºèƒ½ç”Ÿäº§åŠ›ä¼™ä¼´</p>
                <div class="mt-4">
                    <button class="btn btn-outline-light rounded-pill" onclick="showExamples()">
                        <i class="fas fa-lightbulb me-2"></i>æŸ¥çœ‹ç¤ºä¾‹é—®é¢˜
                    </button>
                </div>
            </div>
        </div>

        <!-- è¾“å…¥é¢æ¿ -->
        <div class="input-panel">
            <!-- æ–‡ä»¶ä¸Šä¼ åŒº -->
            <div class="file-dropzone mb-3" 
                 onclick="document.getElementById('fileUpload').click()"
                 ondragover="event.preventDefault(); this.classList.add('dragover')"
                 ondragleave="this.classList.remove('dragover')"
                 ondrop="handleFileDrop(event)">
                <i class="fas fa-cloud-upload-alt me-2"></i>
                æ‹–æ”¾æ–‡ä»¶æˆ–ç‚¹å‡»ä¸Šä¼ 
                <input type="file" id="fileUpload" class="d-none" accept=".txt,.pdf,.docx,.md,.csv">
                <div id="fileName" class="mt-2 text-muted small"></div>
            </div>
            
            <!-- è¾“å…¥æ¡† -->
            <div class="input-group">
                <textarea id="messageInput" 
                         class="form-control ps-4 pe-5 py-3" 
                         placeholder="è¾“å…¥æ¶ˆæ¯..."
                         rows="3"
                         style="border-radius: 1.25rem; resize: none;"
                         oninput="adjustInputHeight(this)"></textarea>
                <button class="btn btn-primary rounded-pill position-absolute end-0 bottom-0 m-2"
                        onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- åº•éƒ¨ç‰ˆæƒ -->
        <footer class="mt-auto py-3 text-center text-muted small">
            <div class="container">
                <i class="bi bi-c-circle me-1"></i>
                <a href="https://yiziyun.com/" target="_blank" class="text-decoration-none text-muted">äº¦æ¢“ç§‘æŠ€</a> Â© 2025
            </div>
        </footer>
    </div>

    <!-- è„šæœ¬ -->
    <script>
        // åˆå§‹åŒ– AOS åŠ¨ç”»
        document.addEventListener('DOMContentLoaded', function () {
            AOS.init({
                duration: 600,
                once: true
            });
            loadModels();
            loadHistory();
            setupFileUpload();
            updateThemeIcon(localStorage.getItem('theme') || 'light');
        });

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function adjustInputHeight(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 150) + 'px';
        }

        // è·å–å½“å‰æ—¶é—´
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // æ·»åŠ æ¶ˆæ¯
        function addMessage(content, isUser = false) {
            const chatWindow = document.getElementById('chatWindow');
            
            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group';
            
            // åˆ›å»ºæ¶ˆæ¯å¤´
            const messageHeader = document.createElement('div');
            messageHeader.className = 'd-flex align-items-center mb-1';
            
            // åˆ›å»ºå¤´åƒ
            const avatar = document.createElement('div');
            avatar.className = `rounded-circle d-flex align-items-center justify-content-center me-2 ${isUser ? 'bg-primary' : 'bg-secondary'}`;
            avatar.style.width = '24px';
            avatar.style.height = '24px';
            avatar.style.fontSize = '0.8rem';
            avatar.style.color = 'white';
            avatar.textContent = isUser ? 'ä½ ' : 'AI';
            
            // åˆ›å»ºå†…å®¹å®¹å™¨
            const contentContainer = document.createElement('div');
            contentContainer.className = 'flex-grow-1';
            
            // åˆ›å»ºæ¶ˆæ¯æ°”æ³¡
            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble ${isUser ? 'user-message' : 'assistant-message'}`;
            messageBubble.innerHTML = `<div class="markdown-content">${DOMPurify.sanitize(marked.parse(content))}</div>`;
            
            // åˆ›å»ºæ—¶é—´æˆ³
            const timestamp = document.createElement('div');
            timestamp.className = 'small mt-1 text-end text-muted';
            timestamp.textContent = getCurrentTime();
            
            // ç»„è£…ç»“æ„
            messageHeader.appendChild(avatar);
            messageHeader.appendChild(document.createTextNode(isUser ? 'ç”¨æˆ·' : 'åŠ©æ‰‹'));
            
            contentContainer.appendChild(messageBubble);
            if (isUser) contentContainer.appendChild(timestamp);
            
            messageGroup.appendChild(messageHeader);
            messageGroup.appendChild(contentContainer);
            
            chatWindow.appendChild(messageGroup);
            scrollToBottom();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveMessage(content, isUser);
            return messageGroup;
        }

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const chatWindow = document.getElementById('chatWindow');
            const typingGroup = document.createElement('div');
            typingGroup.className = 'message-group';
            typingGroup.id = 'typing-indicator';
            
            // åˆ›å»ºæ¶ˆæ¯å¤´
            const messageHeader = document.createElement('div');
            messageHeader.className = 'd-flex align-items-center mb-1';
            
            // åˆ›å»ºå¤´åƒ
            const avatar = document.createElement('div');
            avatar.className = 'rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2';
            avatar.style.width = '24px';
            avatar.style.height = '24px';
            avatar.style.fontSize = '0.8rem';
            avatar.style.color = 'white';
            avatar.textContent = 'AI';
            
            // åˆ›å»ºå†…å®¹å®¹å™¨
            const contentContainer = document.createElement('div');
            contentContainer.className = 'flex-grow-1';
            
            // åˆ›å»ºæ‰“å­—åŠ¨ç”»
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'd-flex align-items-center p-2 rounded';
            typingIndicator.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot mx-1';
                dot.style.width = '6px';
                dot.style.height = '6px';
                dot.style.borderRadius = '50%';
                dot.style.backgroundColor = '#64748b';
                dot.style.animation = 'bounce 1.4s infinite ease-in-out both';
                dot.style.animationDelay = `${i * -0.32}s`;
                typingIndicator.appendChild(dot);
            }
            
            contentContainer.appendChild(typingIndicator);
            messageHeader.appendChild(avatar);
            messageHeader.appendChild(document.createTextNode('åŠ©æ‰‹'));
            typingGroup.appendChild(messageHeader);
            typingGroup.appendChild(contentContainer);
            chatWindow.appendChild(typingGroup);
            scrollToBottom();
            return typingGroup;
        }

        // åŠ è½½æ¨¡å‹
        async function loadModels() {
            try {
                const response = await fetch('admin/modelapi.php?action=models');
                const result = await response.json();
                
                const select = document.getElementById('modelSelect');
                select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
                
                if (result.models && result.models.length > 0) {
                    select.innerHTML = '';
                    result.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">è·å–æ¨¡å‹å¤±è´¥</option>';
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹é”™è¯¯:', error);
                document.getElementById('modelSelect').innerHTML = '<option value="">ç½‘ç»œå¼‚å¸¸</option>';
            }
        }

        // ä¿å­˜æ¶ˆæ¯
        function saveMessage(message, isUser) {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            history.push({
                message,
                isUser,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('chatHistory', JSON.stringify(history));
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            history.forEach(msg => {
                addMessage(msg.message, msg.isUser);
            });
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chat = document.getElementById('chatWindow');
            chat.scrollTop = chat.scrollHeight;
        }

        // æ–‡ä»¶ä¸Šä¼ è®¾ç½®
        function setupFileUpload() {
            const fileUpload = document.getElementById('fileUpload');
            const fileNameDisplay = document.getElementById('fileName');

            fileUpload.addEventListener('change', () => {
                if (fileUpload.files.length > 0) {
                    fileNameDisplay.textContent = `ğŸ“„ ${fileUpload.files[0].name}`;
                } else {
                    fileNameDisplay.textContent = '';
                }
            });

            // æ‹–æ‹½ä¸Šä¼ 
            fileUpload.closest('.file-dropzone').addEventListener('dragover', e => {
                e.preventDefault();
                e.currentTarget.classList.add('dragover');
            });

            fileUpload.closest('.file-dropzone').addEventListener('dragleave', e => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
            });

            fileUpload.closest('.file-dropzone').addEventListener('drop', e => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    fileUpload.files = e.dataTransfer.files;
                    fileNameDisplay.textContent = `ğŸ“„ ${e.dataTransfer.files[0].name}`;
                }
            });
        }

        // å¤„ç†æ–‡ä»¶æ‹–æ”¾
        function handleFileDrop(event) {
            event.preventDefault();
            const fileInput = document.getElementById('fileUpload');
            fileInput.files = event.dataTransfer.files;
            document.getElementById('fileName').textContent = `ğŸ“„ ${event.dataTransfer.files[0].name}`;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            const model = document.getElementById('modelSelect').value;
            const fileInput = document.getElementById('fileUpload');
            
            if (!message && !fileInput.files.length) return;

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('fileName').textContent = '';
            fileInput.value = '';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, true);

            // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
            const typingIndicator = showTypingIndicator();

            // å‡†å¤‡è¯·æ±‚æ•°æ®
            const payload = {
                message,
                model,
                history: JSON.parse(localStorage.getItem('chatHistory') || '[]')
            };

            // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    payload.file = {
                        content: e.target.result.split(',')[1],
                        name: file.name,
                        type: file.type,
                        size: file.size
                    };
                    
                    try {
                        const response = await fetch('admin/modelapi.php', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        });
                        
                        const data = await response.json();
                        typingIndicator.remove();
                        
                        if (data.reply) {
                            addMessage(data.reply, false);
                        } else {
                            addMessage('æ— æ³•è·å–å›å¤ï¼Œè¯·é‡è¯•ã€‚', false);
                        }
                    } catch (error) {
                        typingIndicator.remove();
                        addMessage(`è¯·æ±‚å¤±è´¥: ${error.message}`, false);
                    }
                };
                
                reader.readAsDataURL(file);
            } else {
                // æ— æ–‡ä»¶æ—¶ç›´æ¥å‘é€
                try {
                    const response = await fetch('admin/modelapi.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();
                    typingIndicator.remove();
                    
                    if (data.reply) {
                        addMessage(data.reply, false);
                    } else {
                        addMessage('æ— æ³•è·å–å›å¤ï¼Œè¯·é‡è¯•ã€‚', false);
                    }
                } catch (error) {
                    typingIndicator.remove();
                    addMessage(`è¯·æ±‚å¤±è´¥: ${error.message}`, false);
                }
            }
        }

        // å›è½¦å‘é€
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // ç¤ºä¾‹é—®é¢˜
        function showExamples() {
            const examples = [
                "å¦‚ä½•ä½¿ç”¨Markdownæ ¼å¼ï¼Ÿ",
                "è¯·è§£é‡Šé‡å­è®¡ç®—çš„åŸºæœ¬åŸç†",
                "å¸®æˆ‘å†™ä¸€ä¸ªé¡¹ç›®è®¡åˆ’ä¹¦æ¨¡æ¿",
                "ç”¨Pythonå®ç°æ–æ³¢é‚£å¥‘æ•°åˆ—"
            ];
            
            const exampleModal = document.createElement('div');
            exampleModal.className = 'modal fade';
            exampleModal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">ç¤ºä¾‹é—®é¢˜</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="list-group">
                                ${examples.map(ex => `<li class="list-group-item list-group-item-action example-item" onclick="useExample('${ex}')">${ex}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(exampleModal);
            new bootstrap.Modal(exampleModal).show();
        }

        // ä½¿ç”¨ç¤ºä¾‹
        function useExample(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
            document.querySelector('.modal .btn-close').click();
        }
    </script>
</body>
</html>